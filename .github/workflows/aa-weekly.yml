name: Adobe AA Weekly DMA Report (FTP only)

on:
  schedule:
    # Dual cron so it always aligns with 8:00 PM America/New_York across DST shifts.
    - cron: '0 0 * * 3'   # Wed 00:00 UTC == Tue 8:00 PM ET (DST, UTC-4)
    - cron: '0 1 * * 3'   # Wed 01:00 UTC == Tue 8:00 PM ET (Standard, UTC-5)
  workflow_dispatch:
    inputs:
      force_run:
        description: "Bypass the time guard and run now (useful for tests / reruns)"
        required: false
        type: boolean
        default: false

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Guard:
      # - workflow_dispatch => always RUN=yes (or force_run input)
      # - schedule => RUN=yes only if it's Tue 8:00 PM ET (unless force_run/vars override)
      #
      # NOTE: You can also bypass scheduled rerun guards by setting a repo Variable:
      #   Settings -> Secrets and variables -> Actions -> Variables -> FORCE_RUN=true
      - name: "Guard - compute Tue 8:00 PM ET gate (with test override)"
        id: guard
        env:
          EVENT_NAME: ${{ github.event_name }}
          FORCE_RUN: ${{ inputs.force_run || vars.FORCE_RUN || 'false' }}
        run: |
          python - <<'PY'
          import os
          from datetime import datetime
          from zoneinfo import ZoneInfo

          event_name = os.environ.get("EVENT_NAME", "")
          force = os.environ.get("FORCE_RUN", "").strip().lower() in {"1", "true", "yes", "y"}

          now = datetime.now(ZoneInfo("America/New_York"))
          print("Event:", event_name)
          print("Force override:", force)
          print("Current ET:", now.isoformat())

          # Tue = 1 (Mon=0..Sun=6), 8pm = 20
          is_target_time = (now.weekday() == 1 and now.hour == 20)

          if event_name == "workflow_dispatch":
              run = "yes"
          else:
              run = "yes" if (force or is_target_time) else "no"

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"RUN={run}\n")
          print("RUN =", run)
          PY

      - name: Set up Python
        if: steps.guard.outputs.RUN == 'yes'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install deps
        if: steps.guard.outputs.RUN == 'yes'
        run: pip install -r requirements.txt

      # UPDATED:
      # Computes last completed Sun->Sun (exclusive) week window in America/New_York,
      # then assigns fiscal year + week number from anchors:
      #   FY2025 week1 = 2024-12-29
      #   FY2026 week1 = 2026-01-04
      - name: "Compute prior fiscal week (Sun->Sun exclusive) window (America/New_York) + FY/WK tag"
        if: steps.guard.outputs.RUN == 'yes'
        id: week
        env:
          FISCAL_ANCHORS: "2025=2024-12-29,2026=2026-01-04"
        run: |
          python - <<'PY'
          import os
          from datetime import datetime, timedelta, date
          from zoneinfo import ZoneInfo

          def week_start_sunday(d: date) -> date:
              days_since_sunday = (d.weekday() + 1) % 7  # Mon=0..Sun=6
              return d - timedelta(days=days_since_sunday)

          # Parse anchors like: "2025=2024-12-29,2026=2026-01-04"
          anchors_raw = os.environ.get("FISCAL_ANCHORS", "").strip()
          if not anchors_raw:
              raise SystemExit("FISCAL_ANCHORS is required, e.g. '2025=2024-12-29,2026=2026-01-04'")

          anchors = []
          for part in anchors_raw.split(","):
              part = part.strip()
              if not part:
                  continue
              fy_str, ymd = [x.strip() for x in part.split("=", 1)]
              fy = int(fy_str)
              d = date.fromisoformat(ymd)
              if week_start_sunday(d) != d:
                  raise SystemExit(f"Anchor for FY{fy} must be a Sunday. Got {d} (Sunday start would be {week_start_sunday(d)})")
              anchors.append((fy, d))

          # Sort by date ascending
          anchors.sort(key=lambda x: x[1])

          tz = ZoneInfo("America/New_York")
          today = datetime.now(tz).date()

          current_week_start = week_start_sunday(today)      # Sunday of THIS week
          start = current_week_start - timedelta(days=7)     # Sunday of LAST completed week
          end_excl = current_week_start                      # exclusive end (Sunday)
          end_incl = end_excl - timedelta(days=1)            # inclusive Saturday

          start_iso = f"{start}T00:00:00.000"
          end_iso = f"{end_excl}T00:00:00.000"

          # Pick latest anchor <= start
          applicable = [a for a in anchors if a[1] <= start]
          if applicable:
              fy, fy_start = applicable[-1]
              week_no = ((start - fy_start).days // 7) + 1
              fiscal_tag = f"FY{fy}_WK{week_no:02d}"
              fiscal_y = str(fy)
              fiscal_wk = f"{week_no:02d}"
          else:
              fiscal_tag = ""
              fiscal_y = ""
              fiscal_wk = ""

          cache_key = f"aa-cache-{fiscal_tag + '-' if fiscal_tag else ''}{start}_to_{end_excl}"

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"START_ISO={start_iso}\n")
              f.write(f"END_ISO={end_iso}\n")
              f.write(f"START_DATE={start}\n")
              f.write(f"END_DATE_EXCL={end_excl}\n")
              f.write(f"END_DATE_INCL={end_incl}\n")
              f.write(f"FISCAL_Y={fiscal_y}\n")
              f.write(f"FISCAL_WK={fiscal_wk}\n")
              f.write(f"FISCAL_TAG={fiscal_tag}\n")
              f.write(f"CACHE_KEY={cache_key}\n")

          print("Computed window:")
          print("  START:", start_iso)
          print("  END  :", end_iso, "(exclusive)")
          print("  END_INCL:", end_incl)
          print("  FISCAL_TAG:", fiscal_tag or "(none)")
          print("  CACHE_KEY:", cache_key)
          PY

      - name: Cache AA pages (resumable)
        if: steps.guard.outputs.RUN == 'yes'
        uses: actions/cache@v4
        with:
          path: .aa_cache
          key: ${{ steps.week.outputs.CACHE_KEY }}
          restore-keys: |
            aa-cache-

      - name: Run report (and upload to FTP)
        if: steps.guard.outputs.RUN == 'yes'
        env:
          # ---- Adobe ----
          AA_CLIENT_ID: ${{ secrets.AA_CLIENT_ID }}
          AA_CLIENT_SECRET: ${{ secrets.AA_CLIENT_SECRET }}
          AA_API_KEY: ${{ secrets.AA_API_KEY }}
          AA_ORG_ID: ${{ secrets.AA_ORG_ID }}
          AA_COMPANY_ID: ${{ secrets.AA_COMPANY_ID }}
          START_DATE: ${{ steps.week.outputs.START_ISO }}
          END_DATE: ${{ steps.week.outputs.END_ISO }}

          # ---- Fiscal anchors (FY25 + FY26) ----
          FISCAL_ANCHORS: "2025=2024-12-29,2026=2026-01-04"

          # ---- FTP (Adobe Omniture) ----
          FTP_HOST: ftp.omniture.com
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_DIR: "/dma"
          FTP_TLS: "true"
        run: |
          python aa_dma_by_segment.py

      - name: Get output path
        if: steps.guard.outputs.RUN == 'yes'
        id: out
        run: |
          echo "FILE_PATH=$(cat output/latest.txt)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: steps.guard.outputs.RUN == 'yes'
        uses: actions/upload-artifact@v4
        with:
          name: weekly-aa-report-${{ steps.week.outputs.FISCAL_TAG && format('{0}-', steps.week.outputs.FISCAL_TAG) || '' }}${{ steps.week.outputs.START_DATE }}_to_${{ steps.week.outputs.END_DATE_INCL }}
          path: ${{ steps.out.outputs.FILE_PATH }}
